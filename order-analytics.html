<!DOCTYPE html>
<html lang="en" data-theme="light">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Order Analytics - Avadh BizHub</title>
    <link rel="icon" type="image/jpeg" href="images/logo.jpg">
    <link rel="stylesheet" href="css/style.css">
    <link rel="stylesheet" href="css/loader.css">
</head>

<body>
    <!-- Loading Screen -->
    <!-- Loading Screen (Minimalist) -->
    <div id="appLoader" class="app-loader">
        <div class="loader-content">
            <div class="loader-logo-pulse">üè¢</div>
            <div class="loader-brand">BizHub</div>
            <div class="loader-dots">
                <span></span><span></span><span></span>
            </div>
        </div>
    </div>
    <nav class="navbar">
        <div class="container navbar-container">
            <a href="index.html" class="navbar-logo">üè¢ BizHub</a>
            <button class="navbar-toggle" id="navToggle">‚ò∞</button>
            <ul class="navbar-menu" id="navMenu">
                <li><a href="index.html" class="navbar-link">Home</a></li>
                <li><a href="dashboard.html" class="navbar-link">Dashboard</a></li>
                <li id="authLinks"></li>
            </ul>
        </div>
    </nav>

    <div class="container section">
        <div class="flex justify-between" style="margin-bottom: var(--space-xl);">
            <div>
                <h1>Order Analytics</h1>
                <p id="businessName" style="color: var(--text-tertiary);"></p>
            </div>
            <a href="#" id="backToManage" class="btn btn-outline">‚Üê Back to Manage Orders</a>
        </div>

        <!-- Stats Cards -->
        <div
            style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: var(--space-lg); margin-bottom: var(--space-2xl);">
            <div class="card">
                <h3 style="color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--space-sm);">Total Orders
                </h3>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--primary-500);" id="totalOrders">0</div>
            </div>
            <div class="card">
                <h3 style="color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--space-sm);">Total
                    Revenue</h3>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--success);" id="totalRevenue">‚Çπ0</div>
            </div>
            <div class="card">
                <h3 style="color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--space-sm);">Pending
                    Orders</h3>
                <div style="font-size: 2.5rem; font-weight: 800; color: var(--warning);" id="pendingOrders">0</div>
            </div>
            <div class="card">
                <h3 style="color: var(--text-tertiary); font-size: 0.9rem; margin-bottom: var(--space-sm);">Delivered
                </h3>
                <div style="font-size: 2.5rem; font-weight: 800;" id="deliveredOrders">0</div>
            </div>
        </div>

        <!-- Order Status Breakdown -->
        <div class="card">
            <h2>Order Status Breakdown</h2>
            <div id="statusBreakdown"></div>
        </div>

        <!-- Product Revenue Breakdown -->
        <div class="card" style="margin-top: var(--space-xl);">
            <h2>Product Revenue Breakdown</h2>
            <div id="productRevenue"></div>
        </div>

        <!-- Recent Orders -->
        <div class="card" style="margin-top: var(--space-xl);">
            <h2>Recent Orders</h2>
            <div id="recentOrders"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="js/supabase-config.js"></script>
    <script src="js/loader.js"></script>
    <script src="js/common.js"></script>

    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const businessId = urlParams.get('businessId');

        if (!businessId) {
            alert('Business ID required');
            window.location.href = 'dashboard.html';
        }

        document.getElementById('backToManage').href = `manage-orders.html?id=${businessId}`;

        async function loadAnalytics() {
            try {
                // Get business info
                const { data: business } = await supabase
                    .from('businesses')
                    .select('name')
                    .eq('id', businessId)
                    .single();

                document.getElementById('businessName').textContent = business?.name || '';

                // Get all orders for this business
                const { data: orders, error } = await supabase
                    .from('orders')
                    .select('*, order_items(product_name, quantity, price_at_time)')
                    .eq('business_id', businessId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                // Calculate stats
                const totalOrders = orders.length;
                const totalRevenue = orders.reduce((sum, order) => sum + parseFloat(order.total_amount), 0);
                const pendingOrders = orders.filter(o => o.status === 'pending').length;
                const deliveredOrders = orders.filter(o => o.status === 'delivered').length;

                document.getElementById('totalOrders').textContent = totalOrders;
                document.getElementById('totalRevenue').textContent = `‚Çπ${totalRevenue.toFixed(2)}`;
                document.getElementById('pendingOrders').textContent = pendingOrders;
                document.getElementById('deliveredOrders').textContent = deliveredOrders;

                // Status breakdown
                const statusCounts = {};
                orders.forEach(o => {
                    statusCounts[o.status] = (statusCounts[o.status] || 0) + 1;
                });

                const statusBreakdown = document.getElementById('statusBreakdown');
                statusBreakdown.innerHTML = Object.entries(statusCounts)
                    .map(([status, count]) => `
                        <div style="display: flex; justify-content: space-between; padding: var(--space-md); border-bottom: 1px solid var(--border-color);">
                            <span style="text-transform: capitalize;">${status.replace('_', ' ')}</span>
                            <strong>${count} orders</strong>
                        </div>
                    `).join('');

                // Product revenue breakdown
                const productRevenue = {};
                orders.forEach(order => {
                    order.order_items.forEach(item => {
                        const productName = item.product_name || 'Unknown Product';
                        const itemRevenue = item.quantity * item.price_at_time;
                        productRevenue[productName] = (productRevenue[productName] || 0) + itemRevenue;
                    });
                });

                const sortedProducts = Object.entries(productRevenue)
                    .sort((a, b) => b[1] - a[1]);

                const maxRevenue = sortedProducts[0]?.[1] || 1;

                const productRevenueDiv = document.getElementById('productRevenue');
                if (sortedProducts.length === 0) {
                    productRevenueDiv.innerHTML = '<p style="text-align: center; color: var(--text-tertiary); padding: var(--space-xl);">No product data yet</p>';
                } else {
                    productRevenueDiv.innerHTML = sortedProducts.map(([product, revenue]) => {
                        const percentage = (revenue / maxRevenue) * 100;
                        return `
                            <div style="margin-bottom: var(--space-lg);">
                                <div style="display: flex; justify-content: space-between; margin-bottom: var(--space-xs);">
                                    <span style="font-weight: 600;">${product}</span>
                                    <span style="color: var(--success); font-weight: 700;">‚Çπ${revenue.toFixed(2)}</span>
                                </div>
                                <div style="background: var(--bg-secondary); height: 24px; border-radius: var(--radius-md); overflow: hidden;">
                                    <div style="background: linear-gradient(90deg, var(--primary-500), var(--primary-600)); height: 100%; width: ${percentage}%; transition: width 0.5s ease;"></div>
                                </div>
                            </div>
                        `;
                    }).join('');
                }

                // Recent orders
                const recentOrders = document.getElementById('recentOrders');
                recentOrders.innerHTML = orders.slice(0, 5).map(order => `
                    <div style="padding: var(--space-md); border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; justify-content: space-between;">
                            <div>
                                <strong>${order.customer_name}</strong>
                                <p style="color: var(--text-tertiary); font-size: 0.9rem; margin: 0;">
                                    ${new Date(order.created_at).toLocaleString('en-IN')}
                                </p>
                            </div>
                            <div style="text-align: right;">
                                <div style="font-weight: 700; color: var(--success);">‚Çπ${order.total_amount}</div>
                                <span class="order-status-badge ${order.status}">${order.status.replace('_', ' ')}</span>
                            </div>
                        </div>
                    </div>
                `).join('') || '<p style="text-align: center; color: var(--text-tertiary); padding: var(--space-xl);">No orders yet</p>';

            } catch (error) {
                console.error('Error loading analytics:', error);
            }
        }

        // Initialize
        const checkSupabase = setInterval(() => {
            if (typeof supabase !== 'undefined') {
                clearInterval(checkSupabase);
                loadAnalytics();
            }
        }, 100);
    </script>
</body>

</html>